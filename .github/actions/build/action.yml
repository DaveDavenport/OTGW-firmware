name: arduino-cli build
description: Build using arduino-cli and makefile

runs:
  using: composite
  steps:
    - id: semver
      run: cat version.h  | sed  -n  '/^#define _SEMVER_FULL.*$/s/^#.*"\(.*\)"$/semver=\1/p' >> $GITHUB_OUTPUT
      shell: bash
    - id: create-build-dir
      run: mkdir -p build
      shell: bash
    - id: filesys
      run: |
        make filesystem
        mv build/littlefs.bin build/littlefs-${{steps.semver.outputs.semver}}.bin
      shell: bash
    - id: build
      run: |
        make -j$(nproc)
        find build -type f
        for file in build/**/*.bin; do mv "$file" "build/${file##*/}-${{steps.semver.outputs.semver}}.bin"; done
        for file in build/**/*.elf; do mv "$file" "build/${file##*/}-${{steps.semver.outputs.semver}}.elf"; done
      shell: bash
    - id: upload
      uses: actions/upload-artifact@v4
      with:
        name: OTGW-firmware-${{steps.semver.outputs.semver}} 
        path: |
          build/*.elf
          build/*.bin